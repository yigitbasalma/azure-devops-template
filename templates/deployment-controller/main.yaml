parameters:
  - name: environment
    displayName: Environment
    type: string
  - name: deployment_part
    displayName: Deployment Part
    type: string
  - name: packages
    displayName: Packages
    type: string

steps:
  - task: PowerShell@2
    displayName: Convert package string into Json object
    inputs:
      targetType: 'inline'
      script: |
        $packagesObject = $(Packages) | ConvertFrom-Json
        Write-Host "##vso[task.setvariable variable=PackagesJSON]$packagesObject"

  - ${{ each package in PackagesJSON }}:
    - deployment: ${{ package.name }}
      displayName: ${{ package.name }} Application Deployment
      workspace:
        clean: resources
      environment:
        name: "$(ProjectName)-${{ parameters.environment }}"
        tags: ${{ parameters.deployment_part }}
        resourceType: virtualMachine
      strategy:
        runOnce:
          preDeploy:
            steps:
              - task: CmdLine@2
                displayName: IIS status
                inputs:
                  script: 'iisreset /status'
                name: IISStatus