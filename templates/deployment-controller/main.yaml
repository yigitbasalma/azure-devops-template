parameters:
  - name: environment
    displayName: Environment
    type: string
  - name: deployment_part
    displayName: Deployment Part
    type: string
  - name: packages_json
    displayName: Packages
    type: string

steps:
  - ${{ each package in ${{ parameters.packages_json }} }}:
    - deployment: ${{ package.name }}
      displayName: ${{ package.name }} Application Deployment
      workspace:
        clean: resources
      environment:
        name: "$(ProjectName)-${{ parameters.environment }}"
        tags: ${{ parameters.deployment_part }}
        resourceType: virtualMachine
      strategy:
        runOnce:
          preDeploy:
            steps:
              - task: CmdLine@2
                displayName: IIS status
                inputs:
                  script: 'iisreset /status'
                name: IISStatus